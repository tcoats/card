// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(['inject'], function(inject) {
    var Boid;
    return Boid = (function() {
      function Boid(p, v, a, n) {
        this.cohere = __bind(this.cohere, this);
        this.align = __bind(this.align, this);
        this.separate = __bind(this.separate, this);
        this.step = __bind(this.step, this);
        inject.one('register coordinates')(this, p);
        inject.one('register physics')(this, v, a);
        inject.one('register display')(this, n);
      }

      Boid.prototype.step = function() {
        this.separate();
        this.align();
        return this.cohere();
      };

      Boid.prototype.separate = function() {
        var averagerepulsion, boid, diff, force, _i, _len, _ref;
        averagerepulsion = createVector(0, 0);
        _ref = inject.one('select by distance')(this.c.p, 25);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          boid = _ref[_i];
          if (boid === this) {
            continue;
          }
          diff = p5.Vector.sub(this.c.p, boid.c.p);
          diff.div(diff.mag() * 2);
          averagerepulsion.add(diff);
        }
        if (averagerepulsion.mag() === 0) {
          return;
        }
        force = inject.one('calculate steering')(this, averagerepulsion);
        force.mult(2.5);
        return inject.one('apply force')(this, force);
      };

      Boid.prototype.align = function() {
        var averagedirection, boid, forece, _i, _len, _ref;
        averagedirection = createVector(0, 0);
        _ref = inject.one('select by distance')(this.c.p, 50);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          boid = _ref[_i];
          if (boid === this) {
            continue;
          }
          averagedirection.add(boid.p.v);
        }
        if (averagedirection.mag() === 0) {
          return;
        }
        forece = inject.one('calculate steering')(this, averagedirection);
        forece.mult(1.0);
        return inject.one('apply force')(this, forece);
      };

      Boid.prototype.cohere = function() {
        var averageposition, boid, count, direction, force, _i, _len, _ref;
        averageposition = createVector(0, 0);
        count = 0;
        _ref = inject.one('select by distance')(this.c.p, 100);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          boid = _ref[_i];
          if (boid === this) {
            continue;
          }
          averageposition.add(boid.c.p);
          count++;
        }
        if (averageposition.mag() === 0) {
          return;
        }
        averageposition.div(count);
        direction = p5.Vector.sub(averageposition, this.c.p);
        force = inject.one('calculate steering')(this, direction);
        force.mult(1.0);
        return inject.one('apply force')(this, force);
      };

      return Boid;

    })();
  });

}).call(this);
